<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS_OS</title>
    
    <!-- 1. Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Tailwind Theme --><script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        retro: {
                            bg: 'var(--bg-main)',
                            panel: 'var(--bg-panel)',
                            window: 'var(--bg-window)',
                            content: 'var(--bg-content)',
                            text: 'var(--text-main)',
                            dim: 'var(--text-dim)',
                            inverse: 'var(--text-inverse)',
                            border: 'var(--border-main)',
                            accent: 'var(--accent-main)',
                            'accent-dim': 'var(--accent-dim)',
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. Load React & ReactDOM (UMD) --><script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/@types/react@18/index.d.ts"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 4. Load Babel for JSX --><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Load Lucide Icons (Vanilla UMD) --><script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Font Injection & CSS Variables --><style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        
        :root {
            /* NIGHT MODE (DEFAULT) - Cyberpunk Yellow */
            --bg-main: #000000;
            --bg-panel: #09090b; /* zinc-950 */
            --bg-window: #18181b; /* zinc-900 */
            --bg-content: #09090b; /* zinc-950 */
            
            --text-main: #d4d4d8; /* zinc-300 */
            --text-dim: #71717a; /* zinc-500 */
            --text-inverse: #ffffff;
            
            --border-main: #27272a; /* zinc-800 */
            
            --accent-main: #eab308; /* yellow-500 */
            --accent-rgb: 234, 179, 8;
            --accent-dim: rgba(234, 179, 8, 0.1);
            --accent-glow: rgba(234, 179, 8, 0.5);
            
            --scanline-opacity: 0.6;
            --flicker-opacity: 0.02;
            
            /* Dynamic Hue Rotation Variable */
            --hue-rotate: 0deg;
        }

        .day-mode {
            /* DAY MODE - Deep Amber / Industrial Orange */
            --bg-main: #e4e4e7; /* zinc-200 */
            --bg-panel: #f4f4f5; /* zinc-100 */
            --bg-window: #ffffff; /* white */
            --bg-content: #fafafa; /* zinc-50 */
            
            --text-main: #18181b; /* zinc-900 */
            --text-dim: #71717a; /* zinc-500 */
            --text-inverse: #000000;
            
            --border-main: #a1a1aa; /* zinc-400 */
            
            /* Changed to Amber-700 for much higher contrast on white */
            --accent-main: #b45309; 
            --accent-rgb: 180, 83, 9;
            --accent-dim: rgba(180, 83, 9, 0.1);
            --accent-glow: rgba(180, 83, 9, 0.4);
            
            --scanline-opacity: 0.15;
            --flicker-opacity: 0.01;
        }

        .font-pixel { 
            font-family: 'VT323', monospace; 
            font-size: 1.2rem; 
            /* Added Subtle Text Shadow for Bloom effect */
            text-shadow: 0 0 2px rgba(var(--accent-rgb), 0.5), 0 0 8px rgba(var(--accent-rgb), 0.15); 
        }
        /* FIX: Changed 'Press+Start+2P' to 'Press Start 2P' */
        .font-pixel-bold { 
            font-family: 'Press Start 2P', cursive; 
            /* Added Subtle Text Shadow for Bloom effect */
            text-shadow: 0 0 2px rgba(var(--accent-rgb), 0.5), 0 0 8px rgba(var(--accent-rgb), 0.15); 
        }
        
        @keyframes flicker {
            0% { opacity: var(--flicker-opacity); }
            5% { opacity: 0.05; }
            10% { opacity: var(--flicker-opacity); }
            100% { opacity: var(--flicker-opacity); }
        }
        .animate-flicker { animation: flicker 0.15s infinite; }
        
        /* New: Blocky Terraria/Minecraft style animated background */
        @keyframes block-scroll {
            0% { background-position: 0 0, 100% 100%; }
            100% { background-position: 100% 100%, 0 0; }
        }
        .animated-bg {
            /* Pixelated background using layered gradients */
            background-image: 
                /* Subtle Yellow/Accent Block Layer (50x50 blocks) */
                linear-gradient(45deg, rgba(var(--accent-rgb), 0.05) 25%, transparent 25%),
                linear-gradient(135deg, rgba(var(--accent-rgb), 0.05) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(var(--accent-rgb), 0.05) 75%),
                linear-gradient(135deg, transparent 75%, rgba(var(--accent-rgb), 0.05) 75%);

            background-size: 50px 50px;
            animation: block-scroll 45s linear infinite;
        }


        /* Scrollbar Hiding */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Error Screen Style */
        #error-display { display: none; color: #ef4444; background: #18181b; padding: 20px; font-family: monospace; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; z-index: 10000; }

        /* --- GRANULAR ACCESSIBILITY STYLES --- */
        
        /* 1. Readable Font */
        .a11y-font, .a11y-font * {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            letter-spacing: normal !important;
        }
        /* Ensure icons keep their size/shape */
        .a11y-font svg {
            font-family: inherit !important;
        }

        /* 2. Reduce Motion */
        .a11y-motion *, .a11y-motion {
            animation: none !important;
            transition: none !important;
        }

        /* 3. Clean View (Remove Text Shadows & CRT effects handled in JS) */
        .a11y-clean * {
            text-shadow: none !important;
            box-shadow: none !important;
        }

        /* 4. Large Text (Scale Root Font handled in JS) */
        
        /* 5. Grayscale */
        .a11y-grayscale {
            filter: grayscale(100%) !important;
        }

        /* 6. Dynamic Hue (Replaced fixed invert) */
        .a11y-hue-filter {
            filter: hue-rotate(var(--hue-rotate)) !important;
        }
        /* Rotate images back so they look natural */
        .a11y-hue-filter img, .a11y-hue-filter video {
            filter: hue-rotate(calc(var(--hue-rotate) * -1)) !important;
        }

        /* 7. Wide Spacing */
        .a11y-spacing, .a11y-spacing * {
            line-height: 1.8 !important;
            letter-spacing: 0.1em !important;
            word-spacing: 0.1em !important;
        }

        /* 8. Link Highlights */
        .a11y-links a, .a11y-links button, .a11y-links [role="button"], .a11y-links .cursor-pointer {
            text-decoration: underline !important;
            text-decoration-thickness: 2px !important;
            text-underline-offset: 4px !important;
        }
        
    </style>
</head>
<body class="bg-retro-bg text-retro-text overflow-hidden h-screen w-screen transition-colors duration-300">
    <div id="root"></div>
    <div id="error-display"></div>

    <script type="text/babel">
        // --- ERROR TRAPPING ---
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-display');
            el.style.display = 'block';
            el.innerHTML = `<strong>SYSTEM_ERROR:</strong><br/>${message}<br/><br/>See_console_for_details.`;
        };

        try {
            const { useState, useEffect, useRef, useCallback } = React;

            // --- 64-BIT FORMATTING UTILITY ---
            const format64Bit = (text) => {
                if (typeof text !== 'string') return text;
                
                // 1. Ensure the ampersand is literally surrounded by spaces.
                let result = text.replace(/&/g, ' & ');

                // 2. Replace all internal spaces with underscore, creating the retro look.
                result = result.replace(/\s+/g, '_'); 

                // 3. Define punctuation that should NOT have an adjacent underscore.
                const punctuation = /[:.,()\-]/; 
                
                // 4. Cleanup Punctuation: Remove adjacent underscores next to specified punctuation.
                // This converts "A_:" to "A:"
                result = result.replace(new RegExp(`_(${punctuation.source})`, 'g'), '$1'); 
                // This converts ":_A" to ":A"
                result = result.replace(new RegExp(`(${punctuation.source})_`, 'g'), '$1'); 

                // 5. Cleanup AMPERSAND: Remove the underscores specifically surrounding the '&' to achieve the requested " & " style.
                // This converts "_&_" back to " | "
                result = result.replace(/_&_/g, ' | ');


                // 6. Cleanup PIPE: Replace underscores around pipe with spaces to achieve the requested " | " style.
                result = result.replace(/_\|_/g, ' | ');


                // 7. Ensure commas/colons have a single space if followed by a word character.
                result = result.replace(/([:.,])(\w)/g, '$1 $2');
                
                // 8. Replace any lingering double underscores just in case.
                result = result.replace(/__+/g, '_');

                return result;
            };

            // --- ICON ADAPTER (remains the same) ---
            const toPascalCase = (str) => str.charAt(0).toUpperCase() + str.slice(1);

            const LucideIcon = ({ name, size = 24, color = "currentColor", strokeWidth = 2, className, ...props }) => {
                const iconName = name.charAt(0).toLowerCase() + name.slice(1);
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                
                if (!iconData) {
                    console.warn(`Icon_not_found:__{name}`);
                    return null;
                }
                
                return (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width={size}
                        height={size}
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke={color}
                        strokeWidth={strokeWidth}
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className={className}
                        {...props}
                    >
                        {iconData.map(([tag, attrs], i) => React.createElement(tag, { key: i, ...attrs }))}
                    </svg>
                );
            };

            const Icons = {};
            if (window.lucide && window.lucide.icons) {
                Object.keys(window.lucide.icons).forEach(key => {
                    const pascalKey = toPascalCase(key);
                    Icons[pascalKey] = (props) => <LucideIcon name={key} {...props} />;
                });
            } else {
                throw new Error("Lucide_icons_library_failed_to_load.");
            }

            const SafeIcon = (name) => Icons[name] || (() => null);

            // Icons Used (remains the same)
            const User = SafeIcon('User');
            const Briefcase = SafeIcon('Briefcase');
            const Mail = SafeIcon('Mail');
            const X = SafeIcon('X');
            const Minus = SafeIcon('Minus');
            const Square = SafeIcon('Square');
            const Cpu = SafeIcon('Cpu');
            const Terminal = SafeIcon('Terminal');
            const Folder = SafeIcon('Folder');
            const FileText = SafeIcon('FileText');
            const GraduationCap = SafeIcon('GraduationCap');
            const Layers = SafeIcon('Layers');
            const Ruler = SafeIcon('Ruler');
            const Maximize = SafeIcon('Maximize');
            const Grid = SafeIcon('Grid');
            const AlertTriangle = SafeIcon('AlertTriangle');
            const HardDrive = SafeIcon('HardDrive');
            const Monitor = SafeIcon('Monitor');
            const PenTool = SafeIcon('PenTool');
            const Power = SafeIcon('Power');
            const Move = SafeIcon('Move');
            const Zap = SafeIcon('Zap');
            const RefreshCw = SafeIcon('RefreshCw');
            const Download = SafeIcon('Download');
            const Instagram = SafeIcon('Instagram');
            const Activity = SafeIcon('Activity');
            const Wifi = SafeIcon('Wifi');
            const Gamepad2 = SafeIcon('Gamepad2');
            const Sun = SafeIcon('Sun');
            const Moon = SafeIcon('Moon');
            const Linkedin = SafeIcon('Linkedin');
            const Accessibility = SafeIcon('Accessibility');
            const Type = SafeIcon('Type');
            const EyeOff = SafeIcon('EyeOff');
            const ZoomIn = SafeIcon('ZoomIn');
            const MousePointer = SafeIcon('MousePointer');
            const Droplet = SafeIcon('Droplet'); 
            const MoveHorizontal = SafeIcon('MoveHorizontal');
            const Link2 = SafeIcon('Link2');
            const Target = SafeIcon('Target'); 
            const ScanLine = SafeIcon('ScanLine'); 
            const Palette = SafeIcon('Palette');

            // --- PERSONAL DATA ---
            const PERSONAL_INFO = {
                name: "Yilin Zhu", 
                tagline: "BUILD. BREAK. OPTIMIZE. REPEAT.", 
                intro: [
                    "HBA, MSc (Candidate)", 
                    "Bridging Physical & Digital Experiences",
                    "Designing Human-Centered Spaces & Interfaces",
                ],
                about: "", 
                email: "yilinzhu@atlasruanni.com",
                social: {
                    instagram: "https://instagram.com/atlasruanni",
                    linkedin: "https://www.linkedin.com/in/gevin-zhu",
                    resume: "#" 
                }
            };

            const SKILLS = [
                { name: "ARCH DESIGN", level: 90 }, 
                { name: "MODEL 3D", level: 90 }, 
                { name: "VISL DESIGN", level: 80 }, 
                { name: "UXD RESEARCH", level: 80 }, 
                { name: "PC HARDWARE", level: 70 }, 
            ];

            const EDUCATION = [
                {
                    school: "University of Toronto", 
                    degree: "Honours Bachelor of Arts (HBA) - Specialize in Architectural Studies, Major in Visual Studies (Design), Minor in Visual Studies (Art)",
                    period: "JUNE 2025", 
                    description: "Graduated with Distinction. Focused on fundamental design principles, critical theory, and visual communication strategies."
                },
                {
                    school: "Wilfrid Laurier University", 
                    degree: "Master of Science (MSc) - User Experience (UX) Design",
                    period: "ETA: JAN 2027", 
                    description: "Design intuitive, user-centered experiences that improve how people interact with digital and physical space and systems. Focus is on usability, satisfaction, learnability, and emotional connection across immersive technology, service design, and spatial experiences."
                }
            ];

            const EXPERIENCE = [
                {
                    company: "ZYL Tech", 
                    role: "System Builder", 
                    period: "2025 PRESENT", 
                    description: "Building high-performance rigs from scratch. Diagnosing hardware failures, optimizing thermal airflow, and hardening Windows configs for max stability."
                },
                {
                    company: "Skyview Windows", 
                    role: "CAD Drafter", 
                    period: "2024 2025", 
                    description: "Crushed architectural drafts and analyzed thermal data. Balanced sustainability specs with real-world building codes. Translated technical docs for stakeholders."
                },
                {
                    company: "CACR", 
                    role: "Visual Lead", 
                    period: "2023 2024", 
                    description: "Owned the print & digital visual stack. Took concepts from wireframe to final production, ensuring brand consistency across all output channels."
                }
            ];

            const PROJECTS = [
                {
                    title: "ECO BLUEPRINT", 
                    type: "CAD MODEL", 
                    desc: "Thermal performance planning meets brutalist aesthetics.", 
                    tags: ["AutoCAD", "Physics"],
                    coords: "SEC 09" 
                },
                {
                    title: "BRAND PACK V1", 
                    type: "VISUAL ASSETS", 
                    desc: "High-contrast identity system for audience engagement.", 
                    tags: ["Adobe CC", "Vector"], 
                    coords: "SEC 04" 
                },
                {
                    title: "RIG CONFIGURATOR", 
                    type: "HARDWARE", 
                    desc: "Bespoke PC build specs tailored for extreme workloads.", 
                    tags: ["Hardware", "Cooling"],
                    coords: "SEC 01" 
                }
            ];

            // --- OPTIMIZED CORE UI COMPONENTS (Memoized for Efficiency) ---

            const CornerBrackets = React.memo(({ color = "border-retro-accent", size = "w-2 h-2" }) => (
                <React.Fragment>
                    <div className={`absolute -top-[2px] -left-[2px] ${size} border-t-2 border-l-2 ${color} z-20`}></div>
                    <div className={`absolute -top-[2px] -right-[2px] ${size} border-t-2 border-r-2 ${color} z-20`}></div>
                    <div className={`absolute -bottom-[2px] -left-[2px] ${size} border-b-2 border-l-2 ${color} z-20`}></div>
                    <div className={`absolute -bottom-[2px] -right-[2px] ${size} border-b-2 border-r-2 ${color} z-20`}></div>
                </React.Fragment>
            ));
            
            const SocialButton = React.memo(({ label, icon: Icon, href }) => {
                const shadowClass = 'shadow-[0_4px_0px_var(--accent-dim)] hover:shadow-[0_0_15px_var(--accent-glow)] hover:translate-y-[2px]';
                
                return (
                    <a href={href} target="_blank" rel="noopener noreferrer" 
                        className={`group relative px-6 py-3 bg-retro-panel border-2 border-retro-border 
                            text-retro-dim hover:text-retro-accent hover:border-retro-accent 
                            text-xs font-pixel-bold uppercase transition-all duration-200 overflow-hidden 
                            flex items-center justify-center gap-2 ${shadowClass}`}
                    >
                        <div className="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-retro-accent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="flex items-center gap-2 relative z-10">
                            <Icon size="0.875rem" /> 
                            <span>{label}</span>
                        </div>
                    </a>
                );
            });

            const CRTOverlay = React.memo(() => (
                <div className="pointer-events-none fixed inset-0 z-[9999] overflow-hidden h-full w-full mix-blend-hard-light"
                    style={{ filter: 'blur(0.2px) brightness(1.1)', transform: 'scale(1.01)' }}>
                    
                    {/* Scanlines - Changed to 2px lines for finer grid, slightly stronger RGB blur for phosphor effect */}
                    <div className="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.3)_50%),linear-gradient(90deg,rgba(255,0,0,0.1),rgba(0,255,0,0.05),rgba(0,0,255,0.1))] bg-[length:100%_2px,3px_100%] pointer-events-none" 
                            style={{ opacity: 'var(--scanline-opacity)' }}></div> 
                    
                    {/* Flicker */}
                    <div className="absolute inset-0 bg-white opacity-[0.02] animate-flicker pointer-events-none"></div>
                    {/* Vignette */}
                    <div className="absolute inset-0 bg-[radial-gradient(circle,rgba(0,0,0,0)_60%,rgba(0,0,0,0.8)_100%)] pointer-events-none"></div>
                </div>
            ));

            // XYZ Axis Widget (Rhino Style)
            const XYZAxisWidget = React.memo(() => (
                <div className="absolute bottom-12 left-8 w-16 h-16 pointer-events-none z-0 hidden md:block opacity-60">
                    <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                        {/* Z Axis (Blue) */}
                        <line x1="50" y1="50" x2="50" y2="10" stroke="#3b82f6" strokeWidth="3" />
                        <text x="55" y="10" fill="#3b82f6" fontSize="10" className="font-pixel">Z</text>
                        {/* Y Axis (Green) */}
                        <line x1="50" y1="50" x2="90" y2="30" stroke="#22c55e" strokeWidth="3" />
                        <text x="95" y="30" fill="#22c55e" fontSize="10" className="font-pixel">Y</text>
                        {/* X Axis (Red) */}
                        <line x1="50" y1="50" x2="10" y2="30" stroke="#ef4444" strokeWidth="3" />
                        <text x="0" y="30" fill="#ef4444" fontSize="10" className="font-pixel">X</text>
                        {/* Origin */}
                        <circle cx="50" cy="50" r="2" fill="white" />
                    </svg>
                </div>
            ));

            // --- BOOT SCREEN COMPONENT ---
            const BootScreen = ({ onComplete }) => {
                const [stage, setStage] = useState('LOADING'); // Initial stage set to LOADING
                const [progress, setProgress] = useState(0);
                const [status, setStatus] = useState(format64Bit('INITIATING SYSTEM'));
                const [welcomeOpacity, setWelcomeOpacity] = useState(0); 
                
                // Define the loading phases
                const phases = useRef([
                    { target: 10, speed: 300, message: format64Bit('VERIFYING MEMORY INTEGRITY') },
                    { target: 40, speed: 60, message: format64Bit('LOADING CORE LIBRARIES (V8.0)') },
                    { target: 65, speed: 240, message: format64Bit('DECOMPRESSING ARCHITECTURAL ASSETS') },
                    { target: 99, speed: 120, message: format64Bit('SYNCHRONIZING USER PROFILE: GEVIN ZHU') },
                    { target: 100, speed: 1, message: format64Bit('BOOT COMPLETE. ENGAGING USER INTERFACE.') }
                ]);

                // --- Stage Control Logic ---
                useEffect(() => {
                    let timeout;
                    let interval;

                    
                    if (stage === 'LOADING') {
                        let currentPhase = 0;
                        
                        const updateProgress = () => {
                            // If loading is already complete, stop interval
                            if (currentPhase >= phases.current.length) {
                                clearInterval(interval);
                                setStatus(format64Bit('BOOT SEQUENCE COMPLETE')); 
                                
                                // BLACKOUT 1
                                timeout = setTimeout(() => {
                                    setStage('WELCOME'); // Move to welcome stage (blackout ends)
                                }, 800); 
                                return; // Exit updateProgress early
                            }

                            const phase = phases.current[currentPhase];
                            setStatus(phase.message);

                            setProgress(prev => {
                                let newProgress = prev;
                                
                                if (prev < phase.target) {
                                    const step = 100 / phase.speed; 
                                    newProgress = Math.min(phase.target, prev + step);
                                }
                                
                                // Check if we should advance phase
                                if (newProgress >= phase.target && phase.target < 100) {
                                    currentPhase++;
                                }
                                
                                // Final check for 100% completion (only runs once)
                                if (phase.target === 100 && newProgress >= 99.99) {
                                    currentPhase++; // Ensure we hit the exit condition next tick
                                    newProgress = 100;
                                }

                                return newProgress;
                            });
                        };
                        
                        interval = setInterval(updateProgress, 50); 
                    }
                    
                    else if (stage === 'WELCOME') {
                        let fadeOutTimeout;
                        
                        // 1. Start fade in immediately
                        setWelcomeOpacity(1); 
                        
                        // 2. Start fade out (2500ms = 3000ms total - 500ms fade out duration)
                        fadeOutTimeout = setTimeout(() => {
                             setWelcomeOpacity(0); // Fade Out
                        }, 2500); 

                        // 3. Trigger final blackout after 3000ms
                        const finalLaunchTimeout = setTimeout(() => {
                            setStage('DONE');
                            setTimeout(onComplete, 500); 
                        }, 3000); 
                        
                        return () => { 
                            clearTimeout(fadeOutTimeout); 
                            clearTimeout(finalLaunchTimeout);
                        };
                    }

                    return () => {
                        if (interval) clearInterval(interval);
                        if (timeout) clearTimeout(timeout);
                    };

                }, [stage, onComplete]); // Re-run effect when stage changes

                // --- RENDER LOGIC ---

                if (stage === 'WELCOME') {
                    return (
                        <div className="fixed inset-0 bg-black z-[100] flex flex-col justify-center items-center font-pixel text-retro-accent">
                            {/* FIX: Reduced text size on mobile (sm:hidden) from text-6xl to text-4xl */}
                            <h1 className={`text-4xl sm:text-6xl font-pixel-bold text-retro-accent drop-shadow-[0_0_15px_var(--accent-glow)] transition-opacity duration-500`}
                                style={{ opacity: welcomeOpacity }}
                            >
                                {format64Bit('WELCOME')}
                            </h1>
                        </div>
                    );
                }
                
                // RENDER: LOADING SCREEN / BLACKOUT 1 (when stage is LOADING)
                // When progress hits 100%, the opacity fades out for the blackout (transition: opacity-0)
                const isLoadingVisible = progress < 100;
                const opacityClass = isLoadingVisible ? 'opacity-100' : 'opacity-0';

                // Only render the loading screen wrapper if we are in the LOADING stage
                if (stage === 'LOADING' || stage === 'DONE') {
                    return (
                        <div className="fixed inset-0 bg-black z-[100] p-8 font-pixel text-retro-accent text-lg md:text-xl flex flex-col justify-center items-center overflow-hidden">
                            
                            <div className={`w-full max-w-xl mx-auto space-y-4 transition-opacity duration-300 ${opacityClass}`}> 
                                
                                {/* FIX: Reduced text size on mobile from text-3xl to text-xl */}
                                <h1 className="text-xl sm:text-3xl font-pixel-bold text-center drop-shadow-[0_0_10px_var(--accent-glow)]">ATLAS_OS V64.0</h1>

                                {/* Status Text */}
                                {/* FIX: Reduced text size on mobile from text-sm to text-xs */}
                                <div className="flex items-center justify-start text-base text-retro-dim/80 h-6">
                                    <span className="text-retro-accent">{format64Bit('STATUS:')}</span>
                                    <span className="ml-2 animate-pulse text-retro-text text-xs sm:text-sm">
                                        {status} 
                                    </span>
                                </div>

                                <div className="border-2 border-retro-accent p-2 bg-retro-panel relative">
                                    {/* Progress Bar Container */}
                                    <div className="h-4 bg-retro-bg overflow-hidden relative">
                                        {/* Progress Fill */}
                                        <div 
                                            className="h-full bg-retro-accent transition-all duration-50 ease-linear shadow-[0_0_8px_var(--accent-glow)]"
                                            style={{ width: `${progress}%` }}
                                        >
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Empty div maintained for layout consistency */}
                                <div className="text-center text-xs text-retro-dim pt-2 h-10">
                                    {null}
                                </div>

                            </div>
                        </div>
                    );
                }
                return null;
            };


            // --- SNAKE GAME COMPONENT (Memoized for Efficiency) ---
            const SnakeGame = React.memo(({ isDayMode }) => {
                const canvasRef = useRef(null);
                const [score, setScore] = useState(0);
                const [gameStatus, setGameStatus] = useState('IDLE'); 
                const [highScore, setHighScore] = useState(0);

                // Game Logic Refs
                const gameState = useRef({
                    snake: [{x: 10, y: 10}],
                    food: {x: 15, y: 5},
                    // FIX: Added missing properties to fix SyntaxError
                    direction: {x: 1, y: 0},
                    nextDirection: {x: 1, y: 0},
                    gridSize: 20,
                    gridW: 0,
                    gridH: 0,
                    speed: 100,
                    lastRender: 0
                });

                // Helper functions (defined within component scope)
                const placeFood = () => {
                    const { gridW, gridH, snake } = gameState.current;
                    let valid = false;
                    let newFood = {};
                    
                    // FIX: Implemented logic to check for snake body overlap
                    let attempts = 0;
                    while (!valid && attempts < 100) {
                        newFood = {
                            x: Math.floor(Math.random() * gridW),
                            y: Math.floor(Math.random() * gridH)
                        };
                        valid = !snake.some(segment => segment.x === newFood.x && segment.y === newFood.y);
                        attempts++;
                    }

                    // If we failed after 100 attempts (which shouldn't happen unless grid is full), just place it anyway to avoid an infinite loop, or force game end
                    if (!valid) {
                        console.warn("Could not find a clear spot for food! Placing randomly.");
                        // Forcing placement might lead to instant food consumption, but prevents freezing.
                    }

                    gameState.current.food = newFood;
                };

                const gameOver = () => {
                    setGameStatus('GAMEOVER');
                    if (score > highScore) setHighScore(score);
                };
                
                const startGame = () => {
                    gameState.current.snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
                    gameState.current.direction = {x: 1, y: 0};
                    gameState.current.nextDirection = {x: 1, y: 0};
                    gameState.current.score = 0;
                    setScore(0);
                    setGameStatus('PLAYING');
                    placeFood();
                };

                // Initialize and Handle Resize
                useEffect(() => {
                    const handleResize = () => {
                    if (canvasRef.current) {
                        // FIX: Corrected canvas reference from `canvas.current` to `canvasRef.current`
                        const canvas = canvasRef.current; 
                        const parent = canvas.parentElement;
                        canvas.width = parent.clientWidth;
                        // Subtract space for mobile header (3rem) and mobile footer (4rem) if needed
                        if (window.innerWidth < 640) {
                            // 3rem (48px) for header, 4rem (64px) for footer = 112px total
                            canvas.height = parent.clientHeight - 112; 
                        } else {
                            canvas.height = parent.clientHeight;
                        }
                        
                        gameState.current.gridW = Math.floor(canvas.width / gameState.current.gridSize);
                        gameState.current.gridH = Math.floor(canvas.height / gameState.current.gridSize);
                        // Reposition food if resizing changed grid size significantly
                        if (gameStatus === 'PLAYING') {
                            placeFood();
                        }
                    }
                    };
                    
                    window.addEventListener('resize', handleResize);
                    handleResize(); // Initial size
                    
                    return () => window.removeEventListener('resize', handleResize);
                }, [gameStatus]);

                // Input Handling (Keyboard)
                useEffect(() => {
                    const handleKeyDown = (e) => {
                    if (['p', 'P', 'Escape'].includes(e.key)) {
                        if (gameStatus === 'PLAYING') {
                            setGameStatus('PAUSED');
                        } else if (gameStatus === 'PAUSED') {
                            setGameStatus('PLAYING');
                        }
                        return;
                    }

                    if (gameStatus === 'IDLE' || gameStatus === 'GAMEOVER') {
                        if (['Enter', ' ', 'ArrowUp', 'w'].includes(e.key)) {
                        startGame();
                        }
                        return;
                    }

                    if (gameStatus !== 'PLAYING') return;

                    const { nextDirection } = gameState.current;
                    
                    switch(e.key) {
                        case 'ArrowUp': case 'w':
                        if (nextDirection.y === 0) gameState.current.nextDirection = {x: 0, y: -1};
                        break;
                        case 'ArrowDown': case 's':
                        if (nextDirection.y === 0) gameState.current.nextDirection = {x: 0, y: 1};
                        break;
                        case 'ArrowLeft': case 'a':
                        if (nextDirection.x === 0) gameState.current.nextDirection = {x: -1, y: 0};
                        break;
                        case 'ArrowRight': case 'd':
                        if (nextDirection.x === 0) gameState.current.nextDirection = {x: 1, y: 0};
                        break;
                    }
                    };

                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }, [gameStatus, startGame]);

                // NEW: Input Handling (Touch/Swipe)
                const touchStart = useRef({ x: 0, y: 0 }); 

                useEffect(() => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;

                    // Helper to start game on initial tap/release if idle
                    const handleTouchEnd = () => {
                        if (gameStatus === 'IDLE' || gameStatus === 'GAMEOVER') {
                            startGame();
                        }
                    };

                    const handleTouchStart = (e) => {
                        e.preventDefault();
                        if (e.touches.length > 0) {
                            touchStart.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        }
                    };

                    const handleTouchMove = (e) => {
                        e.preventDefault();
                        if (gameStatus !== 'PLAYING' || e.touches.length === 0) return;

                        const currentTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        const deltaX = currentTouch.x - touchStart.current.x;
                        const deltaY = currentTouch.y - touchStart.current.y;
                        const { nextDirection } = gameState.current;
                        const threshold = 15; // Minimum swipe distance

                        let directionSet = false;

                        if (Math.abs(deltaX) > threshold || Math.abs(deltaY) > threshold) {
                            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                // Horizontal swipe
                                if (deltaX > 0 && nextDirection.x === 0) {
                                    gameState.current.nextDirection = { x: 1, y: 0 };
                                    directionSet = true;
                                }
                                else if (deltaX < 0 && nextDirection.x === 0) {
                                    gameState.current.nextDirection = { x: -1, y: 0 };
                                    directionSet = true;
                                }
                            } else {
                                // Vertical swipe
                                if (deltaY > 0 && nextDirection.y === 0) {
                                    gameState.current.nextDirection = { x: 0, y: 1 };
                                    directionSet = true;
                                }
                                else if (deltaY < 0 && nextDirection.y === 0) {
                                    gameState.current.nextDirection = { x: 0, y: -1 };
                                    directionSet = true;
                                }
                            }
                            
                            if (directionSet) {
                                 touchStart.current = currentTouch;
                            }
                        }
                    };

                    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                    canvas.addEventListener('touchend', handleTouchEnd, { passive: true }); 

                    return () => {
                        canvas.removeEventListener('touchstart', handleTouchStart);
                        canvas.removeEventListener('touchmove', handleTouchMove);
                        canvas.removeEventListener('touchend', handleTouchEnd);
                    };
                }, [gameStatus, startGame]);

                // Game Loop
                useEffect(() => {
                    if (gameStatus !== 'PLAYING') return;

                    let animationFrameId;
                    let lastTime = 0;

                    const loop = (time) => {
                    if (time - lastTime > gameState.current.speed) {
                        update();
                        lastTime = time;
                    }
                    draw();
                    animationFrameId = requestAnimationFrame(loop);
                    };

                    const update = () => {
                    const state = gameState.current;
                    state.direction = state.nextDirection;

                    const head = { ...state.snake[0] };
                    head.x += state.direction.x;
                    head.y += state.direction.y;

                    if (head.x < 0) head.x = state.gridW - 1;
                    if (head.x >= state.gridW) head.x = 0;
                    if (head.y < 0) head.y = state.gridH - 1;
                    if (head.y >= state.gridH) head.y = 0;

                    if (state.snake.some(s => s.x === head.x && s.y === head.y)) {
                        gameOver();
                        return;
                    }

                    state.snake.unshift(head);

                    if (head.x === state.food.x && head.y === state.food.y) {
                        setScore(s => s + 10);
                        placeFood();
                    } else {
                        state.snake.pop();
                    }
                    };

                    const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const { gridSize, snake, food } = gameState.current;

                    // Clear the canvas fully
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // --- REMOVED CAD BACKGROUND GRID DRAWING ---

                    const foodColor = isDayMode ? '#18181b' : '#ffffff';
                    const glowColor = isDayMode ? 'var(--accent-main)' : '#ffffff';

                    ctx.fillStyle = foodColor;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = glowColor;
                    ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
                    ctx.shadowBlur = 0;

                    snake.forEach((segment, i) => {
                        if (i === 0) {
                            ctx.fillStyle = isDayMode ? '#b45309' : '#fef08a'; 
                            ctx.shadowBlur = 10;
                            ctx.shadowColor = isDayMode ? 'rgba(0,0,0,0.2)' : '#eab308';
                        } else {
                            ctx.fillStyle = isDayMode ? '#d97706' : '#eab308'; 
                            ctx.shadowBlur = 0;
                        }
                        ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
                    });
                    };

                    animationFrameId = requestAnimationFrame(loop);
                    return () => cancelAnimationFrame(animationFrameId);
                }, [gameStatus, isDayMode]); 

                useEffect(() => {
                    if (gameStatus !== 'PLAYING' && gameStatus !== 'PAUSED') {
                        // When idle, draw the grid once so the background isn't empty
                        const canvas = canvasRef.current;
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            // Clear previous frame
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            
                            // --- REMOVED IDLE GRID DRAWING ---
                        }
                    }
                }, [gameStatus, isDayMode]); 

                return (
                    // FIX: Added pt-12 (3rem) and pb-16 (4rem) offset on mobile to account for fixed header/footer.
                    <div className="absolute inset-0 flex items-center justify-center z-0 pt-12 pb-16 sm:p-0" onClick={() => window.focus()}>
                    <canvas ref={canvasRef} className="absolute inset-0 z-0 block opacity-95" />
                    
                    <div className="relative z-10 text-center">
                        {gameStatus === 'IDLE' && (
                        <div className="animate-pulse space-y-4">
                            {/* FIX: Reduced text size on mobile from text-4xl to text-3xl */}
                            <h2 className="text-3xl sm:text-4xl font-pixel-bold text-retro-accent drop-shadow-[0_0_10px_var(--accent-dim)]">{format64Bit('SYSTEM IDLE')}</h2>
                            
                            <div className="inline-flex flex-col items-center gap-2 border-2 border-retro-accent bg-retro-panel/80 px-8 py-4 cursor-pointer hover:bg-retro-accent-dim transition-colors" onClick={startGame}>
                                <div className="flex items-center gap-3">
                                    <Gamepad2 className="text-retro-accent" />
                                    {/* FIX: Removed drop-shadow (yellow outline) from the PRESS text */}
                                    <span className="text-base sm:text-lg text-retro-text font-pixel tracking-widest text-shadow-none" style={{textShadow: 'none'}}>{format64Bit('PRESS')}</span>
                                </div>
                            </div>
                        </div>
                        )}

                        {gameStatus === 'PAUSED' && (
                        <div className="space-y-4 bg-retro-panel/90 p-8 border-2 border-retro-accent shadow-[0_0_30px_rgba(0,0,0,0.4)] backdrop-blur-sm">
                            <h2 className="text-4xl font-pixel-bold text-retro-accent animate-pulse">{format64Bit('SYSTEM PAUSED')}</h2>
                            <div className="font-pixel text-xl text-retro-text">{format64Bit('SCORE:')} {score}</div>
                            <div className="font-pixel text-sm text-retro-dim mt-4">{format64Bit("PRESS 'P' TO RESUME")}</div>
                            <button 
                                onClick={() => setGameStatus('PLAYING')}
                                className="mt-4 px-6 py-2 bg-retro-bg border-2 border-retro-text text-retro-text font-pixel hover:bg-retro-text hover:text-retro-inverse transition-all"
                            >
                                {format64Bit('RESUME')}
                            </button>
                        </div>
                        )}

                        {gameStatus === 'GAMEOVER' && (
                        <div className="space-y-4 bg-zinc-950/90 p-8 border-2 border-red-600 shadow-[0_0_30px_rgba(0,0,0,0.4)] backdrop-blur-sm">
                            <h2 className="4xl font-pixel-bold text-red-600 animate-pulse">{format64Bit('CONNECTION LOST')}</h2>
                            <div className="font-pixel text-xl text-red-400">{format64Bit('SCORE:')} {score}</div>
                            <div className="font-pixel text-sm text-red-500/70 mb-4">{format64Bit('HIGH SCORE:')} {highScore}</div>
                            <button 
                                onClick={startGame}
                                className="px-6 py-2 bg-black border-2 border-red-600 text-red-600 font-pixel hover:bg-red-600 hover:text-black transition-all"
                            >
                                {format64Bit('RETRY SEQUENCE()')}
                            </button>
                        </div>
                        )}
                    </div>

                    {/* PLAYING STATE UI - Moved outside the centered container for absolute positioning relative to screen */}
                        {gameStatus === 'PLAYING' && (
                            <React.Fragment>
                                {/* Score at Top */}
                                {/* FIX: Move score to top left of the game area, slightly offset (p-4) */}
                                <div className="absolute top-[3.5rem] left-4 flex flex-col items-start pointer-events-none z-20 select-none sm:top-12 sm:left-1/2 sm:-translate-x-1/2">
                                    <div className="font-pixel text-retro-dim text-xs sm:text-base">SCORE:</div>
                                    <div className="font-pixel-bold text-retro-accent text-xl sm:text-4xl drop-shadow-[0_0_10px_var(--accent-dim)]">
                                        {score}
                                    </div>
                                </div>
                                
                                {/* Pause Instruction at Bottom - Increased size from text-[10px] to text-sm */}
                                <div className="absolute bottom-12 left-1/2 -translate-x-1/2 text-sm text-retro-dim font-pixel tracking-[0.2em] pointer-events-none z-20 select-none opacity-60">
                                    {format64Bit("PRESS 'P' TO PAUSE")}
                                
                                </div>
                            </React.Fragment>
                        )}

                    </div>
                );
            });

            // --- COMPONENT: TOOL ICON (Adjusted to allow mobile header usage) (Memoized) ---
            const ToolIcon = React.memo(({ label, icon: Icon, onClick, active, shadowDirection = 'down', className = '' }) => {
                // Determine if we are on mobile (for removing shadow/translate)
                const isMobile = window.innerWidth < 640;

                const desktopShadowClass = shadowDirection === 'up' 
                    ? 'shadow-[0_-4px_0px_var(--accent-dim)] hover:shadow-[0_0_15px_var(--accent-glow)] hover:translate-y-[-2px]'
                    : 'shadow-[0_4px_0px_var(--accent-dim)] hover:shadow-[0_0_15px_var(--accent-glow)] hover:translate-y-[2px]';
                        
                const desktopActiveShadowClass = shadowDirection === 'up'
                    ? 'shadow-[0_0_10px_var(--accent-glow)] translate-y-[-2px] border-retro-accent'
                    : 'shadow-[0_0_10px_var(--accent-glow)] translate-y-[2px] border-retro-accent';
                
                // FIX: Define mobile classes to remove shadow and translation effects
                const mobileClasses = "shadow-none hover:shadow-none hover:translate-y-0";

                // FIX 1: Removed border-2 border-retro-border from the base class definition
                const baseClasses = `group relative flex items-center justify-center w-[3rem] h-[3rem] transition-all duration-200 bg-retro-panel cursor-pointer`;

                const buttonClasses = `${baseClasses}
                    ${isMobile ? mobileClasses : 'border-2 border-retro-border'}
                    ${active 
                        ? `text-retro-accent ${isMobile ? 'shadow-none translate-y-0' : desktopActiveShadowClass}` 
                        : `text-retro-dim hover:text-retro-accent hover:border-retro-accent ${isMobile ? mobileClasses : desktopShadowClass}`
                    }
                    ${className}
                `;

                return (
                    <button 
                        onClick={onClick}
                        // Use rem based sizing (w-12 h-12 to w-[3rem] h-[3rem])
                        className={buttonClasses}
                        title={label}
                    >
                        <Icon size="1.5rem" strokeWidth={2} />
                        
                        {/* Tooltip visible only on md+ screens */}
                        <div className="absolute left-full ml-[1.25rem] opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 hidden md:block">
                            <div className="relative bg-retro-panel text-retro-accent text-[0.625rem] px-3 py-1 border-2 border-retro-accent font-pixel-bold uppercase tracking-wider shadow-[0_0_10px_var(--accent-dim)] whitespace-nowrap">
                                <CornerBrackets color="border-retro-accent" size="w-1.5 h-1.5" />
                                <span className="relative z-10">&gt;&gt; {label}</span>
                            </div>
                            <div className="absolute top-1/2 right-full w-3 h-[2px] bg-retro-accent transform -translate-y-1/2"></div>
                        </div>
                        {/* Mobile Label removed as it's now in the Mobile Header */}
                    </button>
                );
            });

            // --- WINDOW CONTENT DEFINITIONS (Memoized) ---

            const SkillBar = React.memo(({ skill }) => {
                const [load, setLoad] = useState(0);
                const [overclocked, setOverclocked] = useState(false);
                
                useEffect(() => {
                    const timeout = setTimeout(() => setLoad(skill.level), 300);
                    return () => clearTimeout(timeout);
                }, [skill.level]);

                const triggerOverclock = () => {
                    setOverclocked(true);
                    setTimeout(() => setOverclocked(false), 2000);
                }

                return (
                    <div className="group mb-4 last:mb-0 cursor-pointer select-none" onClick={triggerOverclock}>
                        <div className="flex justify-between text-xs text-retro-dim mb-1 font-pixel-bold">
                        <span className={`transition-colors flex items-center gap-2 ${overclocked ? 'text-red-500' : 'group-hover:text-retro-accent'}`}>
                            <span className={`w-1 h-1 rounded-full ${overclocked ? 'bg-red-500 animate-ping' : 'bg-retro-accent'}`}></span>
                            {format64Bit(skill.name)} {/* Apply format64Bit here */}
                        </span>
                        <span className={`font-pixel ${overclocked ? 'text-red-500 animate-pulse' : 'text-retro-accent'}`}>
                            {overclocked ? format64Bit('WARNING: OVERLOAD') : `${load}%`}
                        </span>
                        </div>
                        <div className={`flex gap-[2px] h-3 p-[2px] border-2 bg-retro-bg relative transition-colors ${overclocked ? 'border-red-500/80' : 'border-retro-border'}`}>
                        <div className={`absolute -left-[2px] -top-[2px] w-1 h-1 border-t-2 border-l-2 ${overclocked ? 'border-red-500' : 'border-retro-dim'}`}></div>
                        <div className={`absolute -right-[2px] -bottom-[2px] w-1 h-1 border-b-2 border-r-2 ${overclocked ? 'border-red-500' : 'border-retro-dim'}`}></div>
                        
                        {[...Array(10)].map((_, i) => (
                            <div 
                                key={i} 
                                className={`flex-1 transition-all duration-150 ${
                                    (i * 10) < (overclocked ? 100 : load) 
                                        ? (overclocked ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.9)]' : 'bg-retro-accent shadow-[0_0_5px_var(--accent-dim)]') 
                                        : 'bg-retro-panel/50'
                                }`}
                            ></div>
                        ))}
                        </div>
                    </div>
                )
            });

            const AboutContent = React.memo(() => (
                <div className="space-y-10 min-h-full flex flex-col justify-start pt-4 max-w-4xl mx-auto relative">
                    <div className="flex flex-col md:flex-row gap-12 items-center justify-center relative z-10">
                    <div className="w-full md:w-56 shrink-0 relative group">
                        <div className="absolute -inset-1 bg-retro-accent/20 blur-sm group-hover:bg-retro-accent/30 transition-all"></div>
                        {/* 1. Changed photo border from accent/50 to dim/50 (gray) */}
                        <div className="aspect-[3/4] bg-retro-bg border-2 border-retro-dim/50 relative overflow-hidden"> {/* Changed bg-black to bg-retro-bg */}
                            <CornerBrackets color="border-retro-accent" />
                            <div className="absolute inset-0 flex items-center justify-center bg-[linear-gradient(transparent_50%,rgba(0,0,0,0.5)_50%)] bg-[length:100%_4px] z-10 pointer-events-none opacity-50"></div>
                            <User size={64} className="text-retro-accent/80 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" />
                            {/* 3. Removed the small '01' binary background text */}
                            <div className="absolute bottom-0 w-full bg-retro-accent/10 border-t-2 border-retro-dim/50 p-2 backdrop-blur-sm z-20">
                                {/* 2. Changed border-t-2 from accent/50 to dim/50 (gray) */}
                                <div className="text-[0.625rem] text-retro-accent font-pixel-bold">{format64Bit('ID: GEVIN ZHU')}</div>
                                <div className="text-[0.5rem] text-retro-dim">{format64Bit('CLASS: UNEMPLOYED')}</div> {/* Updated class */}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1">
                        {/* Name Header */}
                        {/* Reduced size slightly on mobile (text-xl -> text-lg) */}
                        <h1 className="text-lg md:text-3xl text-retro-accent font-pixel-bold mb-1 leading-tight drop-shadow-[0_0_5px_var(--accent-dim)] whitespace-nowrap">
                            {format64Bit(PERSONAL_INFO.name)}
                        </h1>
                        
                        <div className="text-lg font-pixel text-retro-accent mb-6">
                            {format64Bit('OTHER NAME: GEVIN ZHU')} 
                        </div>
                        
                        {/* PLAIN TEXT INTRO SECTION */}
                        <div className="flex flex-col gap-2 mb-8">
                            {PERSONAL_INFO.intro.map((line, i) => (
                                <div key={i} className="text-xs font-pixel-bold text-retro-dim">
                                    {format64Bit(line)}
                                </div>
                            ))}
                        </div>
                        
                        {PERSONAL_INFO.about && (
                            <p className="text-retro-text text-lg md:text-xl leading-8 border-l-4 border-retro-accent/30 pl-6 mb-8 relative">
                            <span className="absolute -left-[6px] top-0 w-2 h-2 bg-retro-accent/50"></span>
                            {format64Bit(PERSONAL_INFO.about)}
                            </p>
                        )}
                        
                        <div className="flex flex-wrap gap-4 justify-start md:justify-start mt-8">
                            
                            {/* LinkedIn Button using the new SocialButton component */}
                            <SocialButton
                                label={format64Bit('LINKED IN')}
                                icon={Linkedin}
                                href={PERSONAL_INFO.social.linkedin}
                            />
                            
                            {/* Instagram Button using the new SocialButton component */}
                            <SocialButton
                                label={format64Bit('INSTA FEED')}
                                icon={Instagram}
                                href={PERSONAL_INFO.social.instagram}
                            />
                        </div>
                    </div>
                    </div>

                    <div className="border-t-2 border-retro-border pt-8 pb-8 relative">
                    {/* Changed text-[8px] to text-[0.5rem] for scaling */}
                    <div className="absolute top-[-8px] left-1/2 -translate-x-1/2 bg-retro-bg border border-retro-border px-2 text-[0.5rem] font-pixel-bold text-retro-accent tracking-widest uppercase">{format64Bit('SYS DIAGNOSTICS')}</div>
                    <div className="flex items-center gap-3 mb-6">
                        <Activity size={18} className="text-retro-accent" />
                        <span className="text-retro-accent font-pixel-bold text-sm">{format64Bit('PERFORMANCE METRICS')}</span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4">
                        {SKILLS.map((skill, i) => (
                            <SkillBar key={i} skill={skill} />
                        ))}
                    </div>
                    </div>
                </div>
            ));

            const ExperienceContent = React.memo(({ isDayMode }) => { // Component must accept isDayMode prop
                // Local helper function to remove underscores for cleaner, readable text
                const formatRead = (text) => {
                    if (typeof text !== 'string') return text;
                    // Replace underscores with spaces, and collapse multiple spaces introduced during cleanup
                    return text.replace(/_/g, ' ').replace(/ +/g, ' ').trim();
                };

                // Determine the correct hover text color class based on the site's mode
                const getHoverTextColorClass = () => {
                    // Day Mode (Dark Amber accent) -> White text for contrast (text-white)
                    // Night Mode (Bright Yellow accent) -> Black text for contrast (text-black)
                    return isDayMode ? 'group-hover:text-white' : 'group-hover:text-black';
                };
                
                const hoverTextColorClass = getHoverTextColorClass();

                return (
                    <div className="space-y-12 pl-4">
                        <div className="relative border-l-2 border-dashed border-retro-border ml-3 md:ml-6 space-y-12 py-2">
                            {EXPERIENCE.map((job, i) => (
                            <div key={i} className="relative pl-8 md:pl-12 group">
                                <div className="absolute -left-[6px] top-1 w-3 h-3 bg-retro-bg border-2 border-retro-accent group-hover:bg-retro-accent group-hover:shadow-[0_0_10px_var(--accent-main)] transition-all duration-300 rounded-sm"></div>
                                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2">
                                <h4 className="text-lg md:text-xl text-retro-text font-pixel-bold group-hover:text-retro-accent transition-colors tracking-wide">{format64Bit(job.role)}</h4>
                                
                                {/* JOB PERIOD FRAME: Changed text color to retro-accent (yellow) */}
                                <span className="text-xs bg-retro-dim/10 text-retro-accent px-2 py-1 border-2 border-retro-border mt-2 sm:mt-0 font-pixel">{format64Bit(job.period)}</span>
                                
                                </div>
                                <div className="text-retro-accent text-sm font-pixel-bold mb-4 flex items-center gap-2">
                                    <Briefcase size={14} /> 
                                    <span className="opacity-50">@</span>
                                    {format64Bit(job.company.toUpperCase())}
                                </div>
                                <div className="relative bg-retro-bg/40 p-4 border-2 border-retro-border group-hover:border-retro-accent/30 transition-colors">
                                    <CornerBrackets color="border-retro-dim group-hover:border-retro-accent/50" size="w-1.5 h-1.5" />
                                    <p className="text-retro-text text-sm md:text-base leading-7 font-pixel relative z-10">
                                        {formatRead(job.description)} 
                                    </p>
                                </div>
                            </div>
                            ))}
                        </div>

                        <div>
                            <div className="flex items-center gap-3 mb-6 border-b-2 border-retro-border pb-2">
                                <Cpu size={18} className="text-retro-accent" />
                                <span className="text-retro-accent font-pixel-bold text-sm">{format64Bit('FIRMWARE UPDATES [EDU]')}</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {EDUCATION.map((edu, i) => (
                                <div key={i} className={`group transition-all duration-200 cursor-pointer 
                                    bg-retro-bg/60 p-4 border-2 border-retro-border 
                                    
                                    /* --- Fixed Hover Styles --- */
                                    hover:bg-retro-accent 
                                    hover:border-retro-text 
                                `}>
                                    <div className="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-100 transition-opacity">
                                        {/* Icon color: Accent -> Optimal Contrast Text */}
                                        <GraduationCap size={16} className={`text-retro-accent transition-colors ${hoverTextColorClass}`} />
                                    </div>
                                    {/* School Title: Text (White/Black) -> Optimal Contrast Text */}
                                    <h4 className={`text-retro-text font-pixel-bold mb-1 text-sm transition-colors ${hoverTextColorClass}`}>{formatRead(edu.school)}</h4>
                                    
                                    {/* Degree: Accent (Yellow/Amber) -> Optimal Contrast Text */}
                                    <p className={`text-xs text-retro-accent mb-3 transition-colors ${hoverTextColorClass}`}>{formatRead(edu.degree)}</p>
                                    
                                    {/* Details & Status: Dim (Gray) -> Optimal Contrast Text */}
                                    <div className={`text-retro-dim text-[10px] border-t-2 border-retro-border pt-2 mt-2 font-pixel group-hover:border-retro-text transition-colors`}>
                                        
                                        <span className={hoverTextColorClass}>{format64Bit('STATUS:')}</span> 
                                        
                                        <span className={`text-retro-text whitespace-pre-wrap transition-colors ${hoverTextColorClass}`}>{formatRead(edu.description)}</span>
                                    </div>
                                </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            });

            const ProjectsContent = React.memo(() => (
                <div className="h-full flex flex-col">
                    <div className="flex items-center justify-between mb-8 bg-retro-bg p-2 border-2 border-retro-border">
                    <div className="flex items-center gap-2 text-retro-accent text-xs font-pixel-bold">
                        <Folder size={14} />
                        <span>{format64Bit('ROOT/PROJECTS/')}</span>
                    </div>
                    <div className="text-xs text-retro-dim font-pixel">
                        {format64Bit('INDEX:')} {PROJECTS.length} // {format64Bit('FREE_SPACE: 12%')}
                    </div>
                    </div>

                    <div className="grid grid-cols-1 gap-6">
                    {PROJECTS.map((project, i) => (
                        <div key={i} className="group relative bg-retro-bg/60 border-2 border-retro-border hover:border-retro-accent/50 transition-colors p-6 flex flex-col md:flex-row gap-6">
                        <CornerBrackets color="border-retro-border group-hover:border-retro-accent/50" />
                        <div className="w-full md:w-32 h-24 bg-retro-panel border-2 border-retro-border flex flex-col items-center justify-center gap-2 group-hover:bg-retro-accent/10 group-hover:border-retro-accent/30 transition-all">
                            <Layers size={24} className="text-retro-dim group-hover:text-retro-accent transition-colors" />
                            <span className="text-[9px] font-pixel-bold text-retro-dim group-hover:text-retro-accent">{format64Bit(project.type)}</span>
                            <div className="flex gap-1 mt-1">
                                <div className="w-1 h-1 bg-retro-dim rounded-full group-hover:bg-retro-accent"></div>
                                <div className="w-1 h-1 bg-retro-dim rounded-full group-hover:bg-retro-accent delay-75"></div>
                                <div className="w-1 h-1 bg-retro-dim rounded-full group-hover:bg-retro-accent delay-150"></div>
                            </div>
                        </div>
                        <div className="flex-1 relative z-10">
                            <div className="flex justify-between items-start mb-2 border-b-2 border-dashed border-retro-border pb-2">
                                <h4 className="text-lg text-retro-text font-pixel-bold group-hover:text-retro-accent transition-colors">{format64Bit(project.title)}</h4>
                                <span className="text-[9px] text-retro-dim font-pixel border-2 border-retro-border px-1">{format64Bit(project.coords)}</span>
                            </div>
                            <p className="text-sm text-retro-dim mb-4 leading-6 font-pixel">{format64Bit(project.desc)}</p>
                            <div className="flex flex-wrap gap-2">
                                {project.tags.map(tag => (
                                <span key={tag} className="text-[10px] px-2 py-1 bg-retro-content text-retro-dim border-2 border-retro-border uppercase tracking-wider group-hover:text-retro-accent group-hover:border-retro-accent/30 transition-colors">
                                    {format64Bit(tag)} {/* Apply format64Bit here too */}
                                </span>
                                ))}
                            </div>
                        </div>
                        </div>
                    ))}
                    </div>
                </div>
            ));
            
            const TerminalContent = React.memo(() => (
                <div className="font-pixel text-xl text-retro-text h-full flex flex-col bg-retro-content p-4 border-2 border-retro-border relative overflow-hidden">
                    <div className="absolute inset-0 opacity-5 bg-[repeating-linear-gradient(0deg,transparent,transparent_2px,var(--accent-main)_2px,var(--accent-main)_4px)] pointer-events-none"></div>
                    <div className="mb-4 text-retro-dim border-b-2 border-retro-border pb-2">
                        {format64Bit('Atlas_OS [v64.0]')} <br/>
                        {format64Bit('(c) Gevin Zhu Industries.')}
                    </div>
                    <div className="flex-1 space-y-3 relative z-10">
                        <div className="flex gap-2">
                            <span className="text-retro-accent">{format64Bit('user@atlas:~$')}</span> 
                            <span>{format64Bit('load_profile --verbose')}</span>
                        </div>
                        <div className="pl-4 text-retro-dim border-l-2 border-retro-border">
                            [{format64Bit('OK')}] {format64Bit('Loading assets...')}<br/>
                            [{format64Bit('OK')}] {format64Bit('Mounting skills...')}<br/>
                            [{format64Bit('OK')}] {format64Bit('Overclocking GPU...')}<br/>
                        </div>
                        <div className="mt-4 flex gap-2">
                            <span className="text-retro-accent">{format64Bit('user@atlas:~$')}</span> 
                            <span>{format64Bit('check_status')}</span>
                        </div>
                        <div className="pl-4 text-retro-dim border-l-2 border-retro-border">
                            <span className="text-retro-text font-bold">{format64Bit('ONLINE')}</span> {format64Bit('- All systems nominal.')}<br/>
                            <span className="text-retro-accent flex items-center gap-2 mt-1">[{format64Bit('WARN')}] {format64Bit('Coffee reserves critical.')} <AlertTriangle size={12}/></span>
                        </div>
                        <div className="mt-4 flex items-center gap-2">
                            <span className="text-retro-accent">{format64Bit('user@atlas:~$')}</span> 
                            <span className="w-2.5 h-5 bg-retro-accent animate-pulse block shadow-[0_0_5px_var(--accent-main)]"></span>
                        </div>
                    </div>
                </div>
            ));

            const ContactContent = React.memo(() => (
                // Use justify-center to center, and apply a margin-top (mt-16) to visually bias the box lower.
                <div className="flex flex-col h-full w-full items-center justify-center relative"> 
                    <div className="bg-retro-panel p-10 border-2 border-retro-border shadow-[0_0_20px_rgba(0,0,0,0.5)] max-w-lg w-full relative backdrop-blur-sm mt-16">
                        <CornerBrackets color="border-retro-accent" />
                        
                        {/* SECURE_LINK Updated to use text-[0.5rem] and font-pixel-bold for consistency with SYS_DIAGNOSTICS */}
                        <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-retro-bg px-4 text-[0.5rem] font-pixel-bold text-retro-accent tracking-widest border-2 border-retro-border uppercase">{format64Bit('SECURE LINK')}</div>
                        
                        <Monitor size={48} className="text-retro-accent mx-auto mb-6 drop-shadow-[0_0_8px_var(--accent-glow)]" strokeWidth={1.5} />
                        <h2 className="2xl font-pixel-bold text-retro-text mb-4 tracking-wide text-center">{format64Bit('OPEN CHANNEL?')}</h2>
                        
                        <a href={`mailto:${PERSONAL_INFO.email}`} className="group relative inline-block w-full py-4 bg-retro-accent/10 hover:bg-retro-accent text-retro-accent hover:text-retro-inverse border-2 border-retro-accent transition-all overflow-hidden">
                            <div className="absolute inset-0 bg-[repeating-linear-gradient(45deg,transparent,transparent_5px,rgba(0,0,0,0.1)_5px,rgba(0,0,0,0.1)_10px)]"></div>
                            <div className="flex items-center justify-center gap-2 relative z-10 font-pixel-bold text-sm uppercase">
                                <Wifi size={16} className="animate-pulse" />
                                <span>{format64Bit('TRANSMIT MESSAGE()')}</span>
                            </div>
                        </a>
                    </div>
                </div>
            ));

            // --- NEW COMPONENT: SYS MENU (formerly A11yMenu) ---
            const SysMenu = React.memo(({ settings, toggleSetting, setSetting, closeMenu }) => {
                // Determine if we are on a mobile size screen to hide certain options
                const isMobile = window.innerWidth < 640;

                return (
                    // MODIFIED: Enforced overflow-hidden on mobile and desktop for unscrollable tab
                    <div className="fixed left-0 right-0 top-12 bottom-16 w-full max-w-full bg-retro-panel border-2 border-retro-accent p-4 shadow-[0_0_20px_rgba(0,0,0,0.5)] z-[100] font-pixel text-xs overflow-hidden md:absolute md:w-64 md:bottom-4 md:left-24 md:top-auto">
                        <CornerBrackets color="border-retro-accent" />
                        
                        <div className="flex justify-between items-center mb-4 border-b border-retro-border pb-2 sticky top-0 bg-retro-panel z-10">
                            {/* FIX 1: Renamed from 'SYS UTILS' */}
                            <span className="text-retro-accent font-bold tracking-widest">{format64Bit('SYS UTILS')}</span>
                            <button onClick={closeMenu} className="text-retro-dim hover:text-retro-accent"><X size={14}/></button>
                        </div>

                        <div className="space-y-3">

                            {/* 2. Reduce Motion */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('motion')}>
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                    <Move size={14} />
                                    <span>{format64Bit('REDUCE MOTION')}</span>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.motion ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* 3. Clean View */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('clean')}>
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                    <EyeOff size={14} />
                                    <span>{format64Bit('CLEAN VIEW')}</span>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.clean ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* 4. Grayscale */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('grayscale')}>
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                    <Droplet size={14} />
                                    <span>{format64Bit('GRAYSCALE')}</span>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.grayscale ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* 5. Change Hue */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('hue')}>
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                    <Palette size={14} />
                                    <span>
                                        {settings.hue > 0 ? format64Bit(`HUE: ${settings.hue}`) : format64Bit('CHANGE HUE')}
                                    </span>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.hue > 0 ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* 7. Link Highlights (Moved up) */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('links')}>
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                    <Link2 size={14} />
                                    <span>{format64Bit('HIGHLIGHT LINKS')}</span>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.links ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* --- DESKTOP ONLY FEATURES --- */}
                            {/* 8. Cursor Highlight (Halo) - REMOVED FOR MOBILE */}
                            {!isMobile && (
                                <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('highlight')}>
                                    <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                        <Target size={14} />
                                        <span>{format64Bit('CURSOR HALO')}</span>
                                    </div>
                                    <div className={`w-3 h-3 border border-retro-accent ${settings.highlight ? 'bg-retro-accent' : ''}`}></div>
                                </div>
                            )}

                            {/* 9. Reading Guide - REMOVED FOR MOBILE */}
                            {!isMobile && (
                                <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('guide')}>
                                    <div className="flex items-center gap-2 text-retro-text group-hover:text-retro-accent">
                                        <ScanLine size={14} />
                                        <span>{format64Bit('READING GUIDE')}</span>
                                    </div>
                                    <div className={`w-3 h-3 border border-retro-accent ${settings.guide ? 'bg-retro-accent' : ''}`}></div>
                                </div>
                            )}
                            
                            {/* --- MOVED TO BOTTOM --- */}

                            {/* 1. Readable Font (MOVED TO BOTTOM) */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('font')}>
                                {/* MODIFIED: Added group-hover:text-red-500 for caution effect */}
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-red-500">
                                    <Type size={14} />
                                    <span>{format64Bit('READABLE FONT')}</span>
                                    {/* NEW: Added caution icon, red on hover */}
                                    <AlertTriangle size={12} className="text-yellow-500 opacity-0 group-hover:opacity-100 group-hover:text-red-500 transition-opacity" title={format64Bit("CAUTION: Modifies_font_and_layout")}/>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.font ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                            {/* 6. Wide Spacing - MOVED TO BOTTOM */}
                            <div className="flex items-center justify-between group cursor-pointer" onClick={() => toggleSetting('spacing')}>
                                {/* MODIFIED: Added group-hover:text-red-500 to change text color on hover */}
                                <div className="flex items-center gap-2 text-retro-text group-hover:text-red-500">
                                    <MoveHorizontal size={14} />
                                    <span>{format64Bit('WIDE SPACING')}</span>
                                    {/* MODIFIED: Added group-hover:text-red-500 to change caution icon color on hover */}
                                    <AlertTriangle size={12} className="text-yellow-500 opacity-0 group-hover:opacity-100 group-hover:text-red-500 transition-opacity" title={format64Bit("CAUTION: Modifies_layout_structure")}/>
                                </div>
                                <div className={`w-3 h-3 border border-retro-accent ${settings.spacing ? 'bg-retro-accent' : ''}`}></div>
                            </div>

                        </div>
                    </div>
                )
            });

            // --- COMPONENT: CAD WINDOW FRAME (Memoized) ---
            const WindowFrame = React.memo(({ id, title, icon: Icon, isOpen, isMinimized, onClose, onMinimize, onFocus, zIndex, position, onMouseDown, children }) => {
                // Determine if we are on a mobile size screen
                // Note: Tailwind 'sm' is 640px. 
                const isMobile = window.innerWidth < 640; 
                
                if (!isOpen) return null;

                // --- DYNAMIC MARKER LOGIC ---
                const contentRef = useRef(null);
                const [markerSize, setMarkerSize] = useState({ count: 15, height: 'auto' });
                const MARKER_UNIT_HEIGHT = 64; // Approximation of marker slot height (py-2 + gap-12 + rotated text height)

                // Use the complex logic only for desktop, minimizing re-renders on resize/drag.
                const updateMarkers = useCallback(() => {
                    if (typeof ResizeObserver === 'undefined' || !contentRef.current) return;
                    
                    const fullContentHeight = contentRef.current.scrollHeight;
                    let neededMarkers = Math.ceil(fullContentHeight / MARKER_UNIT_HEIGHT);
                    
                    neededMarkers = Math.min(15, neededMarkers);
                    neededMarkers = Math.max(5, neededMarkers); 

                    const newMarkerHeight = neededMarkers * MARKER_UNIT_HEIGHT;

                    setMarkerSize({
                        count: neededMarkers,
                        height: `${newMarkerHeight}px`
                    });
                }, [id]);

                useEffect(() => {
                    if (isMobile) return;
                    
                    const observer = new ResizeObserver(updateMarkers);
                    if (contentRef.current) {
                        observer.observe(contentRef.current);
                    }

                    updateMarkers();
                    const interval = setInterval(updateMarkers, 500);

                    return () => {
                        clearInterval(interval);
                        if (contentRef.current) {
                            observer.unobserve(contentRef.current);
                        }
                    };
                }, [id, children, updateMarkers, isMobile]);

                // Conditional styling for Mobile (w-full h-full) vs Desktop (fixed size and position)
                const windowClasses = isMobile 
                    // FIX: Constrain window between fixed header (top-12) and mobile taskbar (bottom-16)
                    ? `fixed top-12 bottom-16 left-0 right-0 w-full border-none` 
                    : `absolute w-[95%] h-[85%] sm:max-w-[900px] sm:max-h-[650px]`;
                
                const windowStyle = isMobile 
                    ? { zIndex: zIndex + 10 } // Ensure open window is on top
                    : { 
                        zIndex,
                        left: position.x,
                        top: position.y,
                        transform: isMinimized ? 'scale(0.9)' : 'scale(1)',
                    };

                // Determine if dragging is allowed (only on desktop/large screens)
                const dragHandler = isMobile ? null : (e) => onMouseDown(e, id);
                const cursorStyle = isMobile ? 'cursor-default' : 'cursor-move';
                
                return (
                    <div 
                    className={`bg-retro-window/95 border-x-2 border-b-2 border-retro-border border-t-2 border-t-retro-accent backdrop-blur-sm shadow-[0_0_30px_rgba(0,0,0,0.4)] flex flex-col overflow-hidden transition-opacity duration-200 ${windowClasses} ${isMinimized ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}
                    style={windowStyle}
                    onMouseDown={onFocus}
                    >
                    <CornerBrackets color="border-retro-accent" size="w-3 h-3" />

                    <div 
                        className={`bg-retro-panel h-10 flex items-center justify-between px-3 border-b-2 border-retro-border select-none group active:cursor-grabbing relative overflow-hidden ${cursorStyle}`}
                        onMouseDown={dragHandler}
                    >
                        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, var(--accent-main) 10px, var(--accent-main) 11px)' }}></div>

                        <div className="flex items-center gap-3 text-retro-accent font-pixel-bold text-xs tracking-wider relative z-10 shadow-[0_0_10px_var(--accent-dim)]">
                        <Icon size={16} strokeWidth={2.5} />
                        <span className="uppercase">{format64Bit(title)}</span>
                        </div>
                        
                        <div className="flex items-center gap-1 relative z-10">
                        {/* MINIMIZE BUTTON: Green appearance for non-destructive hide */}
                        <button onClick={(e) => { e.stopPropagation(); onMinimize(); }} 
                                className="w-6 h-6 flex items-center justify-center bg-retro-bg 
                                border-2 border-retro-border text-green-500 hover:text-green-400 
                                hover:bg-green-900/30 hover:border-green-500 transition-all">
                            <Minus size={12} strokeWidth={3} />
                        </button>
                        
                        {/* CLOSE BUTTON: Red appearance for destructive action */}
                        <button onClick={(e) => { e.stopPropagation(); onClose(); }} 
                                className="w-6 h-6 flex items-center justify-center bg-retro-bg 
                                border-2 border-retro-border text-red-600 hover:text-red-500
                                hover:bg-red-900/30 hover:border-red-600 transition-all">
                            <X size={12} strokeWidth={3} />
                        </button>
                        </div>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Content Area Wrapper (Separates BG from Scroll) */}
                        <div className="flex-1 relative bg-retro-content h-full">
                            
                            {/* Scrollable Content Layer (Absolute Inset-0, Scrolls) */}
                            <div className="absolute inset-0 overflow-y-auto scrollbar-thin scrollbar-thumb-retro-accent scrollbar-track-retro-bg [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
                                
                                {/* SCROLLING CONTAINER: Uses flex to put markers next to content */}
                                <div className="flex w-full min-h-full"> 
                                    {/* Content Area - Added ref to measure scroll height */}
                                    <div ref={contentRef} className="flex-1 relative z-10 p-6 min-h-full font-pixel text-retro-text leading-relaxed cursor-text">
                                        {children}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div className="h-10 bg-retro-panel border-t-2 border-retro-border flex items-center px-4 justify-between text-lg font-pixel text-retro-accent select-none relative">
                        <div className="flex gap-6">
                            <span>{format64Bit('MEM: OK')}</span>
                            <span>{format64Bit('GRID: ACTIVE')}</span>
                            {/* Hide coordinates on mobile */}
                            <span className="hidden sm:inline">{format64Bit('X:')}{Math.round(position.x)} {format64Bit('Y:')}{Math.round(position.y)}</span> 
                        </div>
                        {/* Force SYS_READY status to be green */}
                        <div className="uppercase animate-pulse flex items-center gap-2 text-green-500">
                            <div className="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.9)]"></div>
                            {format64Bit('SYS READY')}
                        </div>
                    </div>
                    </div>
                );
            });

            // --- MAIN APP COMPONENT ---
            function App() {
                // --- STATE DECLARATIONS (Must come first for scope) ---
                const [booting, setBooting] = useState(true);
                const [crtEnabled, setCrtEnabled] = useState(true);
                const [isAppVisible, setIsAppVisible] = useState(false);
                const [isDayMode, setIsDayMode] = useState(false);
                const [gameResetKey, setGameResetKey] = useState(0);
                const [currentTime, setCurrentTime] = useState(format64Bit('SYNCING...'));
                const [a11yMenuOpen, setA11yMenuOpen] = useState(false);
                const [a11ySettings, setA11ySettings] = useState({
                    font: false, motion: false, clean: false, textSize: 100, grayscale: false, hue: 0, spacing: false, links: false, highlight: false, guide: false
                });
                
                // Window management state must be declared here
                const [windowsState, setWindows] = useState([
                    { id: 'about', title: 'USER_PROFILE.EXE', icon: User, isOpen: true, isMinimized: false, zIndex: 1, position: {x: 100, y: 50} },
                    { id: 'projects', title: 'PROJECTS.DIR', icon: Layers, isOpen: false, isMinimized: false, zIndex: 0, position: {x: 120, y: 70} },
                    { id: 'experience', title: 'LOGS.TXT', icon: FileText, isOpen: false, isMinimized: false, zIndex: 0, position: {x: 140, y: 90} },
                    { id: 'terminal', title: 'CMD_PROMPT', icon: Terminal, isOpen: false, isMinimized: false, zIndex: 0, position: {x: 160, y: 110} },
                    { id: 'contact', title: 'MAIL_CLIENT', icon: Mail, isOpen: false, isMinimized: false, zIndex: 0, position: {x: 180, y: 130} },
                ]);

                const [dragState, setDragState] = useState({ isDragging: false, windowId: null, offsetX: 0, offsetY: 0 });


                // Refs for mouse tracking visuals
                const cursorRef = useRef(null);
                const guideRef = useRef(null);

                // --- FUNCTION DEFINITIONS (using useCallback for consistency) ---

                const handleSystemReset = useCallback(() => {
                    // Close all windows
                    setWindows(prev => prev.map((w, i) => ({ ...w, isOpen: false, isMinimized: false, zIndex: 0, position: { x: 100 + (i * 20), y: 50 + (i * 20) } })));
                    // Increment key to force SnakeGame component to unmount and remount
                    setGameResetKey(prev => prev + 1);
                }, [setWindows, setGameResetKey]);

                // FIX 1: This logic ensures that when a tab is opened, it is brought to the front by updating its zIndex.
                // It does NOT change the order of the tab buttons in the mobile footer (which is determined by the `taskbarItems` array order).
                const toggleWindow = useCallback((id) => {
                    setWindows(prev => {
                        const win = prev.find(w => w.id === id);
                        if (!win) return prev;

                        // Calculate max Z-index for focusing
                        const maxZ = Math.max(...prev.map(p => p.zIndex));
                        
                        return prev.map(w => {
                            if (w.id === id) {
                                // Toggle window state, ensure it comes to front if opened
                                return { 
                                    ...w, 
                                    isOpen: true, 
                                    isMinimized: false, 
                                    zIndex: maxZ + 1 
                                };
                            }
                            return w;
                        });
                    });
                }, [setWindows]);

                const closeWindow = useCallback((id) => setWindows(prev => prev.map(w => w.id === id ? { ...w, isOpen: false } : w)), [setWindows]);
                
                const minimizeWindow = useCallback((id) => setWindows(prev => prev.map(w => w.id === id ? { ...w, isMinimized: true } : w)), [setWindows]);
                
                const focusWindow = useCallback((id) => setWindows(prev => {
                    const maxZ = Math.max(...prev.map(p => p.zIndex));
                    return prev.map(w => w.id === id ? { ...w, zIndex: maxZ + 1, isMinimized: false } : w);
                }), [setWindows]);

                const handleMouseDown = useCallback((e, id) => {
                    // Prevent dragging on mobile
                    if (window.innerWidth < 640) return;

                    const win = windowsState.find(w => w.id === id);
                    if(!win) return;
                    focusWindow(id);
                    setDragState({ isDragging: true, windowId: id, offsetX: e.clientX - win.position.x, offsetY: e.clientY - win.position.y });
                }, [windowsState, focusWindow]);

                const handleMouseMove = useCallback((e) => {
                    // A11Y Mouse Tracking logic (Direct DOM manipulation for performance)
                    if (a11ySettings.highlight && cursorRef.current) {
                        cursorRef.current.style.left = `${e.clientX}px`;
                        cursorRef.current.style.top = `${e.clientY}px`;
                    }
                    if (a11ySettings.guide && guideRef.current) {
                        guideRef.current.style.top = `${e.clientY}px`;
                    }

                    if(!dragState.isDragging) return;
                    // Directly modify the windows state based on current position and offset
                    setWindows(prev => prev.map(w => {
                        if(w.id === dragState.windowId) {
                            // Calculate new position
                            return { ...w, position: { x: e.clientX - dragState.offsetX, y: e.clientY - dragState.offsetY } }
                        }
                        return w;
                    }))
                }, [a11ySettings, dragState, setWindows]); // Added setWindows dependency

                const handleMouseUp = useCallback(() => setDragState({ isDragging: false, windowId: null, offsetX: 0, offsetY: 0 }), [setDragState]);
                
                // --- Effects & Computed Values ---

                // Apply theme class to body
                useEffect(() => {
                    if (isDayMode) {
                        document.body.classList.add('day-mode');
                    } else {
                        document.body.classList.remove('day-mode');
                    }
                }, [isDayMode]);

                // Apply Font Size to Root HTML element
                useEffect(() => {
                    document.documentElement.style.fontSize = `${a11ySettings.textSize}%`;
                }, [a11ySettings.textSize]);

                // Apply Hue Rotation
                useEffect(() => {
                    document.documentElement.style.setProperty('--hue-rotate', `${a11ySettings.hue}deg`);
                    if (a11ySettings.hue > 0) {
                        document.body.classList.add('a11y-hue-filter');
                    } else {
                        document.body.classList.remove('a11y-hue-filter');
                    }
                }, [a11ySettings.hue]);

                // Real-time clock update
                useEffect(() => {
                    const updateTime = () => {
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('en-US', {
                            hour: '2-digit', minute: '2-digit', second: '2-digit', 
                            hour12: false
                        });
                        const timezone = now.toLocaleTimeString('en-US', { timeZoneName: 'short' }).split(' ')[2] || 'UTC';
                        setCurrentTime(format64Bit(`${timeStr} | ${timezone}`));
                    };

                    updateTime(); // Initial call
                    const intervalId = setInterval(updateTime, 1000);
                    return () => clearInterval(intervalId); // Cleanup
                }, []);
                
                // Function triggered by BootScreen completion
                const onBootComplete = useCallback(() => {
                    // 1. Hide BootScreen immediately
                    setBooting(false); 
                    
                    // 2. Blackout period (4x 400ms = 1600ms) before making main app visible
                    setTimeout(() => {
                        // 3. Reveal the main UI content
                        setIsAppVisible(true); 
                    }, 1600); // Increased delay
                }, []);


                const toggleA11ySetting = (key) => {
                    if (key === 'hue') {
                        // Cycle hue: 0 -> 60 -> 120 -> 180 -> 240 -> 300 -> 0
                        setA11ySettings(prev => {
                            const nextHue = (prev.hue + 60) % 360;
                            return { ...prev, hue: nextHue };
                        });
                    } else {
                        setA11ySettings(prev => ({ ...prev, [key]: !prev[key] }));
                    }
                }

                const setA11ySettingValue = (key, value) => {
                    setA11ySettings(prev => ({ ...prev, [key]: value }));
                }

                // Helper to construct the main container classes
                const getContainerClasses = () => {
                    let classes = "h-screen w-screen bg-retro-bg text-retro-text overflow-hidden select-none relative flex font-pixel ";
                    if (a11ySettings.font) classes += "a11y-font ";
                    if (a11ySettings.motion) classes += "a11y-motion ";
                    if (a11ySettings.clean) classes += "a11y-clean ";
                    if (a11ySettings.grayscale) classes += "a11y-grayscale ";
                    // hue class is handled via body classList in useEffect for global scope
                    if (a11ySettings.spacing) classes += "a11y-spacing ";
                    if (a11ySettings.links) classes += "a11y-links ";
                    return classes;
                };

                // FIX 1: We still need to find the currently active window to apply focus (zIndex).
                // We keep the logic that prioritizes the most recently focused window.
                const activeWindowId = windowsState.sort((a,b) => b.zIndex - a.zIndex).find(w => w.isOpen && !w.isMinimized)?.id;

                // --- CONTENT RENDERERS ---

                const windowContents = {
                    'about': <AboutContent />,
                    'projects': <ProjectsContent />,
                    'experience': <ExperienceContent isDayMode={isDayMode} />, // Pass isDayMode
                    'terminal': <TerminalContent />,
                    'contact': <ContactContent />
                };

                const renderContent = (id) => {
                    return windowContents[id] || null;
                };
                
                // Get list of navigation items for the Taskbar
                // The order in which they appear here is the order in the mobile taskbar
                const taskbarItems = windowsState.filter(w => ['about', 'projects', 'experience', 'contact'].includes(w.id));
                const utilItems = [
                    { 
                        id: 'crt', 
                        label: format64Bit('CRT'), 
                        icon: Power, 
                        active: crtEnabled, 
                        toggle: () => setCrtEnabled(!crtEnabled), 
                        // FIX: Updated class for CRT button to always have a strong border/color contrast when ON or OFF
                        className: crtEnabled 
                            ? "!border-green-500 !text-green-500 hover:!text-green-400 hover:!border-green-400" 
                            : "!border-retro-border !text-retro-dim hover:!border-retro-accent hover:!text-retro-accent"
                    },
                    { id: 'theme', label: isDayMode ? format64Bit("NIGHT") : format64Bit("DAY"), icon: isDayMode ? Moon : Sun, active: false, toggle: () => setIsDayMode(!isDayMode),
                        className: isDayMode 
                            ? "!border-black !text-black hover:!text-zinc-700 hover:!border-zinc-700 hover:shadow-[0_0_10px_rgba(0,0,0,0.2)]" 
                            : "!border-white !text-white hover:!text-zinc-200 hover:!border-zinc-200 hover:shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                    },
                    // FIX 1: Renamed from 'A11Y' to 'SYS'
                    { id: 'a11y', label: format64Bit('SYS'), icon: Accessibility, active: a11yMenuOpen, toggle: () => setA11yMenuOpen(!a11yMenuOpen),
                        className: a11yMenuOpen
                            ? "!border-retro-accent !text-retro-accent !bg-retro-accent/10" 
                            : ""
                    }
                ];

                // Determine if any main window is open/not minimized
                const isAnyWindowOpen = windowsState.some(w => w.isOpen && !w.isMinimized);
                
                // Opacity class for the main UI components
                const appOpacityClass = isAppVisible ? 'opacity-100' : 'opacity-0 pointer-events-none';


                return (
                    <div className={getContainerClasses()}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                    >
                        {/* A11Y Visual Overlays */}
                        {a11ySettings.highlight && (
                            <div ref={cursorRef} className="fixed w-12 h-12 rounded-full bg-yellow-400/40 border-2 border-yellow-400 pointer-events-none z-[9999] -translate-x-1/2 -translate-y-1/2 mix-blend-difference"></div>
                        )}
                        {a11ySettings.guide && (
                            <div ref={guideRef} className="fixed left-0 w-full h-1 bg-yellow-400/60 pointer-events-none z-[9998] mix-blend-difference"></div>
                        )}

                        {/* Pass the custom onBootComplete handler */}
                        {booting && <BootScreen onComplete={onBootComplete} />}
                        
                        {/* Disable CRT Overlay if Clean View is active or CRT button off */}
                        {crtEnabled && !a11ySettings.clean && <CRTOverlay />}

                        {/* MOBILE/TASKBAR HEADER (Visible on mobile, hidden on sm+) */}
                        {/* FIX: Removed YILIN_ZHU title and switched to justify-between, adding system info on the left */}
                        <div className={`fixed top-0 left-0 right-0 h-12 bg-retro-panel border-b-2 border-retro-border z-50 flex justify-between items-center px-2 sm:hidden transition-opacity duration-500 ${appOpacityClass}`}>
                            {/* FIX: Added system info on phone version (SYS_VER, SECTOR, TIME, NET, MEM) */}
                            <div className="flex flex-col text-left font-pixel text-[0.55rem] text-retro-dim leading-tight">
                                <span>{format64Bit('SYS_VER: 64.0.1')} | {format64Bit('SEC: 07-G')}</span>
                                <span>{format64Bit('TIME:')} {currentTime.split(' | ')[0]}</span>
                                <span className="text-retro-accent">{format64Bit('NET: SECURE')} | {format64Bit('MEM: 640K')}</span>
                            </div>
                            {/* FIX: Removed utility buttons from here, leaving them only in the bottom bar */}
                        </div>

                        {/* DESKTOP SIDEBAR (w-20, hidden on sm/mobile) */}
                        <div className={`w-[5rem] h-full bg-retro-panel border-r-2 border-retro-border z-50 flex-col items-center justify-center py-6 shadow-[5px_0_20px_rgba(0,0,0,0.8)] relative hidden sm:flex transition-opacity duration-500 ${appOpacityClass}`}>
                            <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-retro-panel via-retro-accent/20 to-retro-panel"></div>
                            <div className="flex flex-col items-center justify-center w-full gap-4 relative z-10">
                                
                                <ToolIcon label={format64Bit('RESET')} icon={Grid} onClick={handleSystemReset} active={false} shadowDirection="down" />
                                
                                {/* PDF Button */}
                                <button 
                                    onClick={() => window.open(PERSONAL_INFO.social.resume, '_blank')}
                                    className="group relative flex flex-col items-center justify-center w-[3rem] h-[3rem] border-2 border-retro-border bg-retro-panel hover:bg-retro-bg text-retro-dim hover:text-retro-accent transition-all cursor-pointer shadow-[0_4px_0px_var(--accent-dim)] hover:shadow-[0_0_15px_var(--accent-glow)] hover:translate-y-[2px] hover:border-retro-accent"
                                >
                                    <HardDrive size="1.5rem" />
                                    <span className="text-[0.5rem] font-pixel-bold mt-1">{format64Bit('PDF')}</span>

                                    <div className="absolute left-full ml-[1.25rem] opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                                        <div className="relative bg-retro-panel text-retro-accent text-[0.625rem] px-3 py-1 border-2 border-retro-accent font-pixel-bold uppercase tracking-wider shadow-[0_0_10px_var(--accent-dim)] whitespace-nowrap">
                                            <CornerBrackets color="border-retro-accent" size="w-1.5 h-1.5" />
                                            <span className="relative z-10">&gt;&gt; {format64Bit('RESUME')}</span>
                                        </div>
                                        <div className="absolute top-1/2 right-full w-3 h-[2px] bg-retro-accent transform -translate-y-1/2"></div>
                                    </div>
                                </button>
                                
                                {/* Divider */}
                                <div className="w-[2rem] h-[2px] bg-retro-border"></div> 
                                
                                <ToolIcon label={format64Bit('BIO')} icon={User} onClick={() => toggleWindow('about')} active={activeWindowId === 'about'} shadowDirection="down" />
                                <ToolIcon label={format64Bit('WORK')} icon={Folder} onClick={() => toggleWindow('projects')} active={activeWindowId === 'projects'} shadowDirection="down" />
                                <ToolIcon label={format64Bit('XP')} icon={FileText} onClick={() => toggleWindow('experience')} active={activeWindowId === 'experience'} shadowDirection="down" />
                                <ToolIcon label={format64Bit('CMD')} icon={Terminal} onClick={() => toggleWindow('terminal')} active={activeWindowId === 'terminal'} shadowDirection="down" />
                                <ToolIcon label={format64Bit('MSG')} icon={Mail} onClick={() => toggleWindow('contact')} active={activeWindowId === 'contact'} shadowDirection="down" />
                                
                                <div className="w-[2rem] h-[2px] bg-retro-border"></div>
                                
                                {utilItems.map(item => (
                                    <ToolIcon 
                                        key={item.id}
                                        label={item.label} 
                                        icon={item.icon} 
                                        onClick={item.toggle} 
                                        active={item.active} 
                                        shadowDirection="down" 
                                        className={item.className}
                                    />
                                ))}
                            </div>
                        </div>

                        {a11yMenuOpen && (
                            <SysMenu // FIX 1: Renamed component reference
                                settings={a11ySettings} 
                                toggleSetting={toggleA11ySetting} 
                                setSetting={setA11ySettingValue}
                                closeMenu={() => setA11yMenuOpen(false)}
                            />
                        )}

                        {/* MAIN CONTENT AREA */}
                        {/* Apply the animated background to the game/idle area */}
                        <div className={`flex-1 relative bg-retro-bg overflow-hidden pt-12 sm:pt-0 transition-opacity duration-500 ${appOpacityClass}`}>
                            
                            {/* Background Grid - HIDE ALL BACKGROUND GRIDS/PATTERNS */}
                            <div className="absolute top-8 right-8 text-retro-dim font-pixel-bold text-8xl opacity-10 pointer-events-none select-none hidden sm:block">{format64Bit('ATLAS OS')}</div>
                            
                            {/* Bottom Left System Info (Desktop only) */}
                            <div className="absolute bottom-8 left-8 text-retro-accent font-pixel text-sm pointer-events-none hidden sm:block">
                                {format64Bit('SYS_VER: 64.0.1')} <br/> 
                                {format64Bit('SECTOR: 07-G')} <br/>
                                <span className="text-sm">{format64Bit('TIME:')} {currentTime}</span>
                            </div>
                            
                            {/* Top Right Status (Desktop only) */}
                            <div className="absolute top-8 right-8 text-retro-accent font-pixel text-sm text-right pointer-events-none select-none hidden sm:block">
                                {format64Bit('NET: SECURE')} <br/>
                                {format64Bit('MEM: 640K')}
                            </div>

                            {windowsState.map(w => (
                                <WindowFrame
                                    key={w.id}
                                    {...w}
                                    // FIX: Explicitly pass a function to call closeWindow with the current window ID
                                    onClose={() => closeWindow(w.id)}
                                    // FIX: Explicitly pass a function to call minimizeWindow with the current window ID
                                    onMinimize={() => minimizeWindow(w.id)}
                                    onFocus={() => focusWindow(w.id)}
                                    onMouseDown={handleMouseDown}
                                    position={w.position}
                                >
                                    {renderContent(w.id)}
                                </WindowFrame>
                            ))}

                            {/* BACKGROUND GAME / IDLE STATE */}
                            {/* FIX: Ensure the game canvas itself is not visible when the game is not running (i.e., when windows are open) */}
                            {!isAnyWindowOpen && (
                                <div className="absolute inset-0 z-0">
                                    {/* Added key prop to force reset */}
                                    <SnakeGame key={gameResetKey} isDayMode={isDayMode} />
                                </div>
                            )}
                            
                            {/* Window Taskbar (Desktop only) - Removed based on user request */}
                            
                            {/* MOBILE NAVIGATION BAR (Visible on mobile) */}
                            {/* FIX: Consolidate navigation and utility buttons here */}
                            <div className="fixed bottom-0 left-0 right-0 h-16 bg-retro-panel border-t-2 border-retro-border z-50 flex justify-around items-center px-1 sm:hidden">
                                {taskbarItems.map(item => {
                                    const isActive = activeWindowId === item.id;
                                    // Base classes for mobile buttons (no shadow/up-down effect, NO BORDER)
                                    // FIX 1: Removed border-2 border-retro-border from baseClasses
                                    const baseClasses = 'flex flex-col items-center justify-center w-[3rem] h-[3rem] transition-all duration-200 bg-retro-panel relative shadow-none hover:shadow-none hover:translate-y-0';
                                    
                                    // Active state: flat, borders/text in accent color
                                    // FIX 2: Removed border-retro-accent from activeClasses. Switched active border logic to hover/active text colour.
                                    const activeClasses = 'text-retro-accent';
                                    
                                    // Inactive state: flat, borders/text in dim color (or hover to accent)
                                    const inactiveClasses = 'text-retro-dim hover:text-retro-accent';

                                    return (
                                        <button
                                            key={item.id}
                                            onClick={() => toggleWindow(item.id)} 
                                            // FIX 2: Removed style={{ zIndex: item.zIndex }} as it's not needed for visual order here
                                            className={`${baseClasses} ${isActive ? activeClasses : inactiveClasses}`}
                                        >
                                            <item.icon size="1.25rem" />
                                        </button>
                                    );
                                })}

                                {/* FIX 3: Move utility buttons to the bottom bar */}
                                <div className="h-full border-l-2 border-retro-border/50 mx-1"></div>

                                {utilItems.map(item => {
                                    // FIX 1: Removed border-2 border-retro-border from baseClasses
                                    const baseClasses = 'w-[3rem] h-[3rem] !text-sm flex flex-col items-center justify-center transition-all duration-200 bg-retro-panel relative shadow-none hover:shadow-none hover:translate-y-0';
                                    
                                    // Since ToolIcon is used here, we override ToolIcon's base classes which include borders on desktop, 
                                    // but ensure mobile explicitly avoids borders by combining base mobile classes with item-specific classes.
                                    const finalClasses = `${baseClasses} ${item.className.replace('!border-retro-border', '')} !border-0`; // Remove any lingering border class
                                    
                                    return (
                                        <button 
                                            key={item.id}
                                            onClick={item.toggle} 
                                            className={finalClasses}
                                            title={item.label}
                                        >
                                            <item.icon size="1.5rem" strokeWidth={2} />
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // Mount the app
            // FIX: Defer mounting until the window (including UMD globals) is ready.
            window.onload = function() {
                try {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    // Note: The BootScreen component calls onBootComplete, which manages the transition to App visibility.
                    root.render(<App />);
                } catch (e) {
                    console.error(format64Bit("Delayed React mount error:"), e);
                    // Pass the error to the outer handler if needed, but window.onerror is already defined
                    const el = document.getElementById('error-display');
                    el.innerHTML = `<strong>CRITICAL FAILURE:</strong><br/>${e.message}<br/><br/>See console for stack trace.`;
                    el.style.display = 'block';
                }
            };
            
        } catch (err) {
            console.error(err);
            const el = document.getElementById('error-display');
            el.style.display = 'block';
            // Using a simple error message here since format64Bit might not be fully functional during a critical failure
            el.innerHTML = `<strong>CRITICAL FAILURE:</strong><br/>${err.message}<br/><br/>See console for stack trace.`;
        }
    </script>
</body>
</html>
